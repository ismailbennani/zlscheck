(** constants, initial state **)

type shift = UP | DOWN

let pi = 4.0 *. atan 1.0

let iei = 0.0219914882835559         (* moment of inertia of the engine and the impeller *)
let engine_feedback_gain = 1. /. iei


let p_final_drive_ratio = 3.23
let p_drag_friction = 40.
let p_aerodynamic_drag = 0.02
let p_wheel_radius = 1.
let p_vehicle_inertia = 12.09414785731247

let iv_inv = 1. /. p_vehicle_inertia

let p_initial_transmission_out_speed = 0. /. p_wheel_radius *. p_final_drive_ratio

let initial_speed = 0.               (* initial speed of the vehicle (mph) *)

let p_mph = 60. /. 5280.             (* ft.min-1 to mph ratio *)
let l_speed_coef = 2. *. pi *. p_wheel_radius
let p_initial_wheel_speed = initial_speed /. p_mph /. l_speed_coef

let static twait = 0.08

(** utils **)

let lookup_engine    (l, c) =
  MyOp.get
  (Interp.interp2 (Consts.line_engine,
                   Consts.col_engine,
                   Consts.vals_engine)
                   (MyOp.make l, MyOp.make c))
let lookup_interpup  (l, c) =
  MyOp.get
  (Interp.interp2 (Consts.line_interpup,
                   Consts.col_interpup,
                   Consts.vals_interpup)
                   (MyOp.make l, MyOp.make c))
let lookup_interpdn  (l, c) =
  MyOp.get
  (Interp.interp2 (Consts.line_interpdn,
                   Consts.col_interpdn,
                   Consts.vals_interpdn)
                   (MyOp.make l, MyOp.make c))
let lookup_factork   (l)    =
  MyOp.get
  (Interp.interp1 (Consts.line_factork,
                   Consts.vals_factork)
                   (MyOp.make l))
let lookup_torkratio (l)    =
  MyOp.get
  (Interp.interp1 (Consts.line_torkratio,
                   Consts.vals_torkratio)
                   (MyOp.make l))
let lookup_gear      (l)    =
  MyOp.get
  (Interp.interp1 (Consts.line_gear,
                   Consts.vals_gear)
                   (MyOp.make l))

(** algorithm **)

let torque_converter(ne, nin) = (ti, tt) where
  rec speedratio = nin /. ne
  and factorK = lookup_factork speedratio
  and torqueratio = lookup_torkratio speedratio
  and quotient = ne /. factorK
  and impeller = quotient *. quotient
  and turbine = impeller *. torqueratio

  and ti = impeller and tt = turbine

let transmissionratio(tin, gear, nout) = (tout, nin) where
  rec gear_lookup = lookup_gear gear
  and tout = tin *. gear_lookup
  and nin  = nout *. gear_lookup

let transmission(ne, gear, nout) = (ti, tout) where
  rec ti, turbine_torque = torque_converter(ne, nin)
  and tout, nin = transmissionratio(turbine_torque, gear, nout)
